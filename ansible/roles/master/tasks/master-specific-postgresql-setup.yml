# Name:          master-specific-postgresql-setup.yml
# Purpose:       Set up the pgpool installation.
# Author(s):     Nick Hughes
# Created:       2018-viii-07
# Modifications: 2018-viii-?  - 
# Copyright:     (c) Norwegian Meteorological Institute, 2018
# Citing:        https://doi.org/10.5281/zenodo.xxxxxx
#
# License:       This file is part of the BIFROST ice charting system.
#                BIFROST is free software: you can redistribute it and/or modify
#                it under the terms of the GNU General Public License as published by
#                the Free Software Foundation, version 3 of the License.
#                http://www.gnu.org/licenses/gpl-3.0.html
#                This program is distributed in the hope that it will be useful,
#                but WITHOUT ANY WARRANTY without even the implied warranty of
#                MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
---

# Master server specific PostgreSQL settings, see https://www.fatdragon.me/blog/2016/05/postgresql-ha-pgpool-ii-part-2

# Add replication slots
# NB: this will break the build if the replication slot already exists
# might consider deleting pre-existing on or allowing it to pass if 
# it already exists, if the build fails because of this just delete
# /home/postgres and restart
- name: add replication slots 
  become: true
  become_user: postgres
  vars:
    ansible_ssh_pipelining: true
  expect:
    command: psql -d template_postgis -U postgres -c "SELECT * FROM pg_create_physical_replication_slot('10_168_33_20');"
    responses:
      (?i)Password: "postgres"

# And change postgresql.conf again to:
- name: change wal_level in postgresql.conf
  replace: dest=/etc/postgresql/{{ psql_version }}/main/postgresql.conf
           regexp="#wal_level = replica" 
           replace="wal_level = hot_standby"
           backup=yes

- name: change max_replication_slots in postgresql.conf
  replace: dest=/etc/postgresql/{{ psql_version }}/main/postgresql.conf
           regexp="#max_replication_slots = 10" 
           replace="max_replication_slots = 3"
           backup=yes
           
- name: change max_replication_slots in postgresql.conf
  replace: dest=/etc/postgresql/{{ psql_version }}/main/postgresql.conf
           regexp="#max_wal_senders = 10" 
           replace="max_wal_senders = 3"
           backup=yes
           
